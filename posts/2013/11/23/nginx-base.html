<!DOCTYPE html>
<html lang="en">

<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
    <meta name="google-site-verification" content="SzE6WCs23qFevgBzRIuG9vcfLU0lW_Vd5hFT-cJOLBE" />
    <title>Nginx基础笔记</title>
    <meta charset="utf-8" />
    <meta name="description" content="">
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

        <link rel="shortcut icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="/theme/css/styles.css" media="all" />
        <link rel="stylesheet" href="/theme/css/ui.totop.css" media="all" />

        <!--
        <link href='http://fonts.googleapis.com/css?family=Gentium+Basic:400,700,400italic,700italic|Gentium+Book+Basic:400,700|PT+Sans+Narrow|Source+Code+Pro' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/theme/css/normalize.css" media="all" />
        -->

        <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
        <!--[if IE 7]>
            <link rel="stylesheet" href="/theme/css/font-awesome-ie7.min.css">
        <![endif]-->

        <link href="/" type="application/atom+xml" rel="alternate" title="wklken's blog ATOM Feed" />
        <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wklken's blog RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->


</head>

<body id="index" class="home">
    <div id="page" class="row">
        <div class="large-8 large-centered columns">

        <header id="header">
            <div class="constraint">
                <div class="o"> 
                    <a href="/"><h1 class="banner">Wklken <span class="blue"> Python</span></h1></a>

                <div class="social">
                            <a href="https://github.com/wklken" target='_blank'><i class="icon-github-sign icon-2x"></i></a>
                            <a href="http://weibo.com/wklken" target='_blank'><i class="icon-weibo icon-2x"></i></a>
                            <a href="mailto:wklken@yeah.net"><i class="icon-envelope icon-2x"></i></a>
                            <a href="/feed.xml" target='_blank'><i class="icon-rss-sign icon-2x"></i></a>
                </div>
                <div class="nav">
                            <a href="/">首页</a>
                            <a href="/categories.html">分类</a>
                            <a href="/archives.html">归档</a>
                            <a href="/pages/projects.html">项目</a>
                            <a href="/pages/tools.html">工具</a>
                            <a href="/pages/books.html">书单</a>
                            <a href="/pages/aboutme.html">关于</a>

                </div>

                </div>
            </div>
        </header><!-- /#banner -->

        <section id="main">

<article id="article">
    <section id="header">
        <!--
        <div class="meta">2013年11月23日</div>
        <h1 id="title"> Nginx基础笔记 </h1>
        -->
        <div class="meta"> &nbsp; </div>
        <h1> Nginx基础笔记 </h1>
    </section>
    <section id="content">
        <p>nginx小结</p>
<h3>资源</h3>
<blockquote>
<p>资源</p>
</blockquote>
<p>Nginx <a href="http://nginx.org/">官网</a></p>
<p>Nginx <a href="http://nginx.org/en/download.html">官方下载地址</a></p>
<p>Nginx最佳实践配置项目 <a href="https://github.com/Umkus/nginx-boilerplate">地址</a></p>
<p>Nginx Configuration <a href="http://wiki.nginx.org/Configuration">wiki</a></p>
<blockquote>
<p>教程</p>
</blockquote>
<p>agentzh的Nginx教程 <a href="http://openresty.org/download/agentzh-nginx-tutorials-zhcn.html">链接</a></p>
<p>Nginx开发从入门到精通 <a href="http://tengine.taobao.org/book/index.html">入口</a></p>
<blockquote>
<p>文章</p>
</blockquote>
<p>Nginx战斗准备-优化指南 <a href="http://www.oschina.net/translate/nginx-setup">入口</a></p>
<p>Nginx模块开发入门 <a href="http://blog.codinglabs.org/articles/intro-of-nginx-module-development.html">入口</a></p>
<p>解析Nginx负载均衡 <a href="http://stblog.baidu-tech.com/?p=2027">入口</a></p>
<p>Nginx Rewrite研究笔记 <a href="http://blog.cafeneko.info/2010/10/nginx_rewrite_note/">入口</a></p>
<h2>安装</h2>
<h3>ubuntu下</h3>
<div class="codehilite"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nginx</span>

<span class="err">启动</span>
<span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">start</span>       <span class="err">#通过</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="err">下的启动文件启动。</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">nginx</span> <span class="n">start</span><span class="err">#通过</span><span class="n">ubuntu</span><span class="err">的服务管理器启动</span>

<span class="err">配置文件位置</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<h3>编译安装</h3>
<p>1.先决条件</p>
<div class="codehilite"><pre><span class="mf">1.</span><span class="n">gcc</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">gcc</span>
<span class="mf">2.</span><span class="n">pcre</span><span class="p">(</span><span class="n">Perl</span> <span class="n">Compatible</span> <span class="n">Regular</span> <span class="n">Expression</span><span class="p">)</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">libpcre3</span> <span class="n">libpcre3</span><span class="o">-</span><span class="n">dev</span>
<span class="mf">3.</span><span class="n">zlib</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">zliblg</span> <span class="n">zliblg</span><span class="o">-</span><span class="n">dev</span>
<span class="mf">4.</span><span class="n">openssl</span>
<span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openssl</span> <span class="n">opensll</span><span class="o">-</span><span class="n">dev</span>

<span class="cp">#如果非apt，可以使用下载包手动编译安装的方式处理</span>
</pre></div>


<p>2.下载包</p>
<div class="codehilite"><pre><span class="n">www</span><span class="p">.</span><span class="n">nginx</span><span class="p">.</span><span class="n">net</span> <span class="err">下载稳定版</span>
<span class="n">wget</span> <span class="n">http</span><span class="o">:</span><span class="c1">//nginx.org/download/nginx-1.4.4.tar.gz</span>
</pre></div>


<p>3.解压安装</p>
<div class="codehilite"><pre><span class="n">tar</span> <span class="o">-</span><span class="n">xzvf</span> <span class="n">nginx</span><span class="o">-</span><span class="mf">1.4.4</span><span class="p">.</span><span class="n">tar</span><span class="p">.</span><span class="n">gz</span>
<span class="cp">#默认，安装目录/usr/local/nginx</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span>
<span class="n">make</span>
<span class="n">make</span> <span class="n">install</span>

<span class="cp">#配置</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">conf</span><span class="o">-</span><span class="n">path</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span>

<span class="err">可以配置一些其他选项</span>

<span class="err">安装后查看下目录下的</span><span class="n">Configuration</span> <span class="n">summary</span>
</pre></div>


<p>4.init脚本</p>
<div class="codehilite"><pre><span class="err">需要给</span><span class="n">nginx</span><span class="err">建立一个</span><span class="n">init</span><span class="err">脚本</span>
<span class="err">从网上捞一个，放入</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span>
</pre></div>


<p>推荐编译配置</p>
<div class="codehilite"><pre><span class="mf">1.</span><span class="err">使用不同</span><span class="n">prefix</span><span class="err">，方便指定不同版本</span><span class="p">,</span><span class="err">也便于升级</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">-</span><span class="mf">1.4.4</span>
</pre></div>


<h2>基本操作</h2>
<div class="codehilite"><pre><span class="err">查看帮助</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">h</span>

<span class="err">立即停止进程</span><span class="p">(</span><span class="n">TERM</span><span class="err">信号</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">s</span> <span class="n">stop</span>

<span class="err">温和停止进程</span><span class="p">(</span><span class="n">QUIT</span><span class="err">信号</span><span class="p">)</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">s</span> <span class="n">quit</span>

<span class="err">重加载</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">nginx</span> <span class="n">reload</span> <span class="err">#有</span><span class="n">init</span><span class="err">脚本情况下</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">s</span> <span class="n">reload</span> <span class="err">#原生</span>

<span class="err">检测配置文件是否正确</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">t</span> <span class="err">#生产路径下的</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nginx</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ken</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">conf</span> <span class="err">#可以测试某个临时文件</span>
</pre></div>


<h2>HTTP基本配置</h2>
<h3>配置说明</h3>
<div class="codehilite"><pre><span class="err">注释，#</span>
<span class="err">每条指令总是以分好结束</span><span class="p">(;)</span>
<span class="err">配置继承：在一个区块中嵌套其他区段，那么被嵌套的区段会继承其父区段的设置</span>
<span class="err">字符串，可以没有引号，但是如果存在特殊字符（空格，分号，花括号）需要用引号引起</span>
<span class="err">单位：大小</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="n">K</span> <span class="n">m</span><span class="o">/</span><span class="n">M</span><span class="p">)</span> <span class="err">时间值</span><span class="p">(</span><span class="n">ms</span><span class="o">/</span><span class="n">s</span><span class="o">/</span><span class="n">m</span><span class="o">/</span><span class="n">h</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="n">w</span><span class="o">/</span><span class="n">M</span><span class="o">/</span><span class="n">y</span> <span class="err">默认</span><span class="n">s</span><span class="p">)</span>
<span class="err">模块提供各种变量值，可以进行读取和赋值（每个模块提供变量列表需要自己去查）</span>
</pre></div>


<h3>配置文件目录结构</h3>
<div class="codehilite"><pre><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span>

<span class="o">-</span> <span class="n">mime</span><span class="p">.</span><span class="n">types</span> <span class="err">一个文件扩展列表，它们与</span><span class="n">MIME</span><span class="err">类型关联</span>
<span class="o">-</span> <span class="n">fastcgi</span><span class="p">.</span><span class="n">conf</span> <span class="err">与</span><span class="n">FastCGI</span><span class="err">相关的配置文件</span>
<span class="o">-</span> <span class="n">proxy</span><span class="p">.</span><span class="n">conf</span> <span class="err">与</span><span class="n">Proxy</span><span class="err">相关的配置文件</span>
<span class="o">-</span> <span class="n">nginx</span><span class="p">.</span><span class="n">conf</span> <span class="err">应用程序的基本配置文件</span>
<span class="o">-</span> <span class="n">sites</span><span class="o">/</span>
    <span class="o">|-</span> <span class="n">a</span><span class="p">.</span><span class="n">conf</span> <span class="err">#允许给每个单独网站建立一个配置文件</span>
    <span class="o">|-</span> <span class="n">b</span><span class="p">.</span><span class="n">conf</span>
    <span class="o">|-</span> <span class="n">dir</span><span class="o">/</span>
        <span class="o">|-</span> <span class="n">c</span><span class="p">.</span><span class="n">conf</span>

<span class="err">需要在</span><span class="n">nginx</span><span class="p">.</span><span class="n">conf</span><span class="err">中使用包含命令</span>
<span class="n">include</span> <span class="n">sites</span><span class="cm">/*.conf;</span>
<span class="cm">include sites/*/</span><span class="o">*</span><span class="p">.</span><span class="n">conf</span><span class="p">;</span>
</pre></div>


<h3>配置文件结构</h3>
<div class="codehilite"><pre><span class="n">http</span> <span class="p">{</span> <span class="err">#嵌入配置文件的根部，</span> <span class="err">一个</span><span class="n">http</span><span class="err">里可以配置多个</span><span class="n">server</span>

    <span class="n">server</span> <span class="p">{</span> <span class="err">#声明一个站点</span>
        <span class="n">server_name</span> <span class="n">www</span><span class="p">.</span><span class="n">website</span><span class="p">.</span><span class="n">com</span><span class="p">;</span> <span class="err">#监听的主机名</span>
        <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span> <span class="err">#监听套接字所使用的</span><span class="n">ip</span><span class="err">地址和端口号</span>

        <span class="n">error_page</span> <span class="mi">404</span> <span class="o">/</span><span class="n">not_found</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>
        <span class="n">error_page</span> <span class="mi">500</span> <span class="mi">501</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="o">/</span><span class="n">server_error</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>

        <span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>

        <span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">website</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">html</span><span class="p">;</span> <span class="err">#定义文档的根目录</span>

        <span class="err">#</span><span class="n">location</span><span class="p">,</span> <span class="err">通过制定的模式与客户端请求的</span><span class="n">URI</span><span class="err">相匹配</span>
        <span class="n">location</span> <span class="o">/</span> <span class="p">{</span> <span class="err">#网站的特定位置</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">/</span><span class="n">admin</span><span class="o">/</span> <span class="p">{</span> <span class="err">#网站的特定位置</span> <span class="err">#</span>
            <span class="n">alias</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">locked</span><span class="o">/</span><span class="p">;</span> <span class="err">#只能放在</span> <span class="n">location</span><span class="err">区段中，为指定路径提供别名</span>
        <span class="p">}</span>

        <span class="err">#操作符</span><span class="p">,</span><span class="err">匹配时跟定义顺序无关</span>
        <span class="n">location</span> <span class="o">=</span> <span class="o">/</span><span class="n">abcd</span> <span class="p">{</span> <span class="err">#精确匹配，不能用正则</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">/</span><span class="n">abc</span><span class="o">/</span> <span class="p">{</span> <span class="err">#</span><span class="n">url</span><span class="err">必须以指定模式开始，不能用正则</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">^~</span> <span class="o">/</span><span class="n">abcd</span><span class="err">$</span> <span class="p">{</span> <span class="err">#吴标致行为，</span><span class="n">URI</span><span class="err">定位必须以指定模式开始，如果匹配，停止搜索其他模式</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">~</span> <span class="o">^/</span><span class="n">abcd</span><span class="err">$</span> <span class="p">{</span> <span class="err">#正则匹配，区分大小写</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="o">~*</span> <span class="o">^/</span><span class="n">abcd</span><span class="err">$</span> <span class="p">{</span> <span class="err">#正则匹配，不区分大小写</span>
        <span class="p">}</span>
        <span class="n">location</span> <span class="err">@</span><span class="n">test</span>  <span class="p">{</span> <span class="err">#定义</span><span class="n">location</span><span class="err">区段名，客户端不能访问，内部产生的请求可以</span><span class="p">,</span><span class="err">例如</span><span class="n">try_files</span><span class="err">或</span><span class="n">error_page</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2>模块</h2>
<h3>模块化</h3>
<p>nginx真正的魅力在于它的模块，整个应用程序建立在一个模块化系统之上，在编译时，可以对每一个模块进行启用或者禁用</p>
<h3>index模块</h3>
<p>定义往回走哪index页</p>
<div class="codehilite"><pre><span class="n">index</span> <span class="n">index</span><span class="p">.</span><span class="n">php</span> <span class="n">index</span><span class="p">.</span><span class="n">html</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">website</span><span class="o">/</span><span class="n">index</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>
<span class="cp">#可以指定多个，但是ngxin提供第一个找到的文件</span>
</pre></div>


<h3>Log模块</h3>
<div class="codehilite"><pre><span class="n">access_log</span> <span class="o">/</span><span class="n">file</span><span class="o">/</span><span class="n">path</span><span class="p">;</span>
<span class="n">error_log</span> <span class="o">/</span><span class="n">file</span><span class="o">/</span><span class="n">path</span> <span class="n">error</span><span class="p">;</span>  <span class="err">#</span><span class="n">level</span><span class="o">:</span> <span class="n">debug</span><span class="o">/</span><span class="n">info</span><span class="o">/</span><span class="n">notice</span><span class="o">/</span><span class="n">warn</span><span class="o">/</span><span class="n">error</span><span class="o">/</span><span class="n">crit</span>
</pre></div>


<p>日志格式</p>
<div class="codehilite"><pre><span class="n">log_format</span> <span class="n">main</span> <span class="err">&#39;$</span><span class="n">remote_addr</span> <span class="o">-</span> <span class="err">$</span><span class="n">remote_user</span> <span class="p">[</span><span class="err">$</span><span class="n">time_local</span><span class="p">]</span> <span class="s">&quot;$request&quot;</span> <span class="err">&#39;</span>
<span class="err">&#39;$</span><span class="n">status</span> <span class="err">$</span><span class="n">body_bytes_sent</span> <span class="s">&quot;$http_referer&quot;</span> <span class="err">&#39;</span>
<span class="err">&#39;</span><span class="s">&quot;$http_user_agent&quot;</span> <span class="err">$</span><span class="n">http_x_forwarded_for</span><span class="err">&#39;</span><span class="p">;</span>

<span class="n">access_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">log</span> <span class="n">main</span><span class="p">;</span>
</pre></div>


<h3>Real IP模块</h3>
<p>默认编译nginx不包含这个模块</p>
<p>当通过nginx将用户请求进行转发时，接收请求的应用要拿到用户的真实IP(经转发拿到的是服务器的IP)</p>
<div class="codehilite"><pre><span class="n">real_ip_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span><span class="p">;</span>
</pre></div>


<h3>Access模块</h3>
<p>可以禁用ip段</p>
<p>语法</p>
<div class="codehilite"><pre><span class="cp">#如果规则之间有冲突，会以最前面匹配的规则为准</span>
<span class="n">deny</span> <span class="n">IP</span><span class="p">;</span>
<span class="n">deny</span> <span class="n">subnet</span><span class="p">;</span>
<span class="n">allow</span> <span class="n">IP</span><span class="p">;</span>
<span class="n">allow</span> <span class="n">subnet</span><span class="p">;</span>
<span class="cp"># block all ips</span>
<span class="n">deny</span>    <span class="n">all</span><span class="p">;</span>
<span class="cp"># allow all ips</span>
<span class="n">allow</span>    <span class="n">all</span><span class="p">;</span>
</pre></div>


<p>配置一个blockips.conf,然后在nginx.conf中include</p>
<p>e.g</p>
<div class="codehilite"><pre><span class="n">location</span> <span class="p">{</span>
    <span class="n">allow</span> <span class="mf">127.0.0.1</span><span class="p">;</span> <span class="err">#允许本地</span><span class="n">ip</span> <span class="err">注意顺序，</span><span class="n">allow</span><span class="err">要放在前面</span>
    <span class="n">deny</span> <span class="n">all</span><span class="p">;</span> <span class="err">#禁止其他</span><span class="n">ip</span>
<span class="p">}</span>
</pre></div>


<h3>Rewrite模块</h3>
<p>作用：执行URL重定向,允许你去掉带有恶意的URL，包含多个参数（修改）</p>
<p>利用正则的匹配，分组和引用，达到目的</p>
<p>break/return/set等</p>
<div class="codehilite"><pre><span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="err">$</span><span class="n">uri</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">break</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">uri</span> <span class="o">~</span> <span class="o">^/</span><span class="n">admin</span><span class="o">/</span><span class="p">){</span>
    <span class="k">return</span> <span class="mi">403</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="n">uri</span> <span class="o">~</span> <span class="o">^/</span><span class="n">search</span><span class="o">/</span><span class="p">(.</span><span class="o">*</span><span class="p">)</span><span class="err">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">set</span> <span class="err">$</span><span class="n">query</span> <span class="err">$</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">rewrite</span> <span class="o">^</span> <span class="o">/</span><span class="n">search</span><span class="p">.</span><span class="n">php</span><span class="o">?</span><span class="n">q</span><span class="o">=</span><span class="err">$</span><span class="n">query</span><span class="o">?</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>例子</p>
<div class="codehilite"><pre><span class="n">A</span><span class="o">:</span><span class="n">http</span><span class="o">://</span><span class="n">website</span><span class="o">.</span><span class="na">com</span><span class="sr">/search/s</span><span class="n">ome</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">keywords</span>
<span class="n">B</span><span class="o">:</span><span class="n">http</span><span class="o">://</span><span class="n">website</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">search</span><span class="o">.</span><span class="na">php</span><span class="o">?</span><span class="n">q</span><span class="o">=</span><span class="n">some</span><span class="o">-</span><span class="n">search</span><span class="o">-</span><span class="n">keywords</span>
<span class="n">rewrite</span> <span class="o">^/</span><span class="n">search</span><span class="sr">/(.*)$ /s</span><span class="n">earch</span><span class="o">.</span><span class="na">php</span><span class="o">?</span><span class="n">q</span><span class="o">=</span><span class="n">$1</span><span class="o">?;</span>

<span class="n">A</span><span class="o">:</span><span class="n">http</span><span class="o">://</span><span class="n">website</span><span class="o">.</span><span class="na">com</span><span class="sr">/user/31/</span><span class="n">James</span>
<span class="n">B</span><span class="o">:</span><span class="n">http</span><span class="o">://</span><span class="n">website</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">user</span><span class="o">.</span><span class="na">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="mi">31</span><span class="o">&amp;</span><span class="n">name</span><span class="o">=</span><span class="n">James</span>
<span class="n">rewrite</span> <span class="o">^/</span><span class="n">user</span><span class="sr">/([0-9]+)/(.+)$ /</span><span class="n">user</span><span class="o">.</span><span class="na">php</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="n">$1</span><span class="o">&amp;</span><span class="n">name</span><span class="o">=</span><span class="n">$2</span><span class="o">?;</span>

<span class="n">A</span><span class="o">:</span><span class="n">http</span><span class="o">://</span><span class="n">website</span><span class="o">.</span><span class="na">com</span><span class="sr">/index.php/param1/param2/</span><span class="n">param3</span>
<span class="n">B</span><span class="o">:</span><span class="n">http</span><span class="o">://</span><span class="n">website</span><span class="o">.</span><span class="na">com</span><span class="sr">/index.php/</span><span class="o">?</span><span class="n">p1</span><span class="o">=</span><span class="n">param1</span><span class="o">&amp;</span><span class="n">p2</span><span class="o">=</span><span class="n">param2</span><span class="o">&amp;</span><span class="n">p3</span><span class="o">=</span><span class="n">param3</span>
<span class="n">rewrite</span> <span class="o">^/</span><span class="n">index</span><span class="o">.</span><span class="na">php</span><span class="sr">/(.*)/(.*)/(.*)$ /i</span><span class="n">ndex</span><span class="o">.</span><span class="na">php</span><span class="o">?</span><span class="n">p1</span><span class="o">=</span><span class="n">$1</span><span class="o">&amp;</span><span class="n">p2</span><span class="o">=</span><span class="n">$2</span><span class="o">&amp;</span><span class="n">p3</span><span class="o">=</span><span class="n">$3</span><span class="o">?;</span>
</pre></div>


<p>rewrite语法</p>
<div class="codehilite"><pre><span class="n">rewrite</span> <span class="n">A</span> <span class="n">B</span> <span class="n">option</span><span class="p">;</span>
<span class="nl">options:</span>
        <span class="n">last</span> <span class="o">:</span><span class="err">表示完成</span><span class="n">rewrite</span>
        <span class="nl">break:</span><span class="err">本规则匹配完成后，终止匹配，不再匹配后面的规则</span>
        <span class="nl">redirect:</span><span class="err">返回</span><span class="mi">302</span><span class="err">临时重定向，地址栏会显示跳转后的地址</span>
        <span class="nl">permanent:</span><span class="err">返回</span><span class="mi">301</span><span class="err">永久重定向，地址栏会显示跳转后的地址</span>
</pre></div>


<h3>Proxy模块</h3>
<p>默认模块，允许你讲客户端的HTTP请求转到后端服务器</p>
<div class="codehilite"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">proxy_pass_header</span> <span class="n">Server</span><span class="p">;</span>  <span class="err">#该指令强制一些被忽略的头传递到客户端</span>
    <span class="n">proxy_redirect</span> <span class="n">off</span><span class="p">;</span> <span class="err">#允许改写出现在</span><span class="n">HTTP</span><span class="err">头却被后端服务器触发重定向的</span><span class="n">URL</span><span class="p">,</span><span class="err">对相应本身不做任何处理</span>
    <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="err">$</span><span class="n">http_host</span><span class="p">;</span> <span class="err">#允许你重新定义代理</span><span class="n">header</span><span class="err">值再转到后端服务器</span><span class="p">.</span><span class="err">目标服务器可以看到客户端的原始主机名</span>
    <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span> <span class="err">#目标服务器可以看到客户端的真实</span><span class="n">ip</span><span class="err">，而不是转发服务器的</span><span class="n">ip</span>
    <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Scheme</span> <span class="err">$</span><span class="n">scheme</span><span class="p">;</span>
    <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//localhost:8080;</span>
<span class="p">}</span>
</pre></div>


<h3>upstream模块</h3>
<div class="codehilite"><pre><span class="n">upstream</span> <span class="n">up_name</span> <span class="p">{</span>
    <span class="n">server</span> <span class="mf">192.168.0.1</span><span class="o">:</span><span class="mi">9000</span> <span class="n">weight</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span> <span class="err">#权重</span>
    <span class="n">server</span> <span class="mf">192.168.0.2</span><span class="o">:</span><span class="mi">9000</span> <span class="n">weight</span><span class="o">=</span><span class="mi">5</span> <span class="n">max_fails</span><span class="o">=</span><span class="mi">5</span> <span class="n">fail_timeout</span><span class="o">=</span><span class="mi">60</span><span class="n">s</span><span class="p">;</span> <span class="err">#在</span><span class="mi">60</span><span class="n">s</span><span class="err">内，其错误通信超过</span><span class="mi">5</span><span class="err">次</span><span class="p">,</span><span class="err">认为该服务失效</span>
    <span class="n">server</span> <span class="mf">192.168.0.3</span><span class="o">:</span><span class="mi">9000</span> <span class="n">down</span><span class="p">;</span> <span class="err">#服务标记为离线，不再使用</span>
    <span class="n">server</span> <span class="mf">192.168.0.4</span><span class="o">:</span><span class="mi">9000</span> <span class="n">backup</span><span class="p">;</span> <span class="err">#备份服务器，其他全部宕机了才启用</span>
<span class="p">}</span>
</pre></div>


<h2>其他</h2>
<h3>配置静态化目录</h3>
<div class="codehilite"><pre>    <span class="n">location</span> <span class="o">/</span><span class="k">static</span><span class="o">/</span>
    <span class="p">{</span>
        <span class="n">root</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="p">;</span>
        <span class="n">autoindex</span> <span class="n">off</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<h3>负载均衡</h3>
<div class="codehilite"><pre><span class="n">http</span> <span class="p">{</span>
    <span class="n">include</span> <span class="n">mime</span><span class="p">.</span><span class="n">types</span><span class="p">;</span>
    <span class="n">default_type</span> <span class="n">application</span><span class="o">/</span><span class="n">octet</span><span class="o">-</span><span class="n">stream</span><span class="p">;</span>

    <span class="n">keepalive_timeout</span> <span class="mi">120</span><span class="p">;</span>

    <span class="n">tcp_nodelay</span> <span class="n">on</span><span class="p">;</span>

    <span class="n">upstream</span> <span class="n">up_localhost</span> <span class="p">{</span>
        <span class="n">server</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">8000</span> <span class="n">weight</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span>
        <span class="n">server</span> <span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">8001</span> <span class="n">weight</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">server</span> <span class="p">{</span>
        <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>

        <span class="n">server_name</span> <span class="n">localhost</span><span class="p">;</span>

        <span class="n">location</span> <span class="o">/</span><span class="p">{</span>
            <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//up_localhost;</span>
            <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="err">$</span><span class="n">host</span><span class="p">;</span>
            <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real_IP</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
            <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="err">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>


<h3>控制页面缓存</h3>
<div class="codehilite"><pre><span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.(</span><span class="n">htm</span><span class="o">|</span><span class="n">html</span><span class="o">|</span><span class="n">gif</span><span class="o">|</span><span class="n">jpg</span><span class="o">|</span><span class="n">jpeg</span><span class="o">|</span><span class="n">png</span><span class="o">|</span><span class="n">bmp</span><span class="o">|</span><span class="n">ico</span><span class="o">|</span><span class="n">css</span><span class="o">|</span><span class="n">js</span><span class="o">|</span><span class="n">txt</span><span class="p">)</span><span class="err">$</span> <span class="p">{</span>
    <span class="n">root</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">webapp</span><span class="p">;</span>
    <span class="n">expires</span> <span class="mi">24</span><span class="n">h</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">expires</span> <span class="mi">1</span> <span class="n">January</span><span class="p">,</span> <span class="mi">1970</span><span class="p">,</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">01</span> <span class="n">GMT</span><span class="p">;</span>
<span class="n">expires</span> <span class="mi">60</span><span class="n">s</span><span class="p">;</span>
<span class="n">expires</span> <span class="mi">30</span><span class="n">m</span><span class="p">;</span>
<span class="n">expires</span> <span class="mi">24</span><span class="n">h</span><span class="p">;</span>
<span class="n">expires</span> <span class="mi">1</span><span class="n">d</span><span class="p">;</span>
<span class="n">expires</span> <span class="n">max</span><span class="p">;</span>
<span class="n">expires</span> <span class="n">off</span><span class="p">;</span>
</pre></div>


<h3>nginx的内置变量</h3>
<div class="codehilite"><pre><span class="err">$</span><span class="n">arg_PARAMETER</span> <span class="err">这个变量包含在查询字符串时</span><span class="n">GET</span><span class="err">请求</span><span class="n">PARAMETER</span><span class="err">的值。</span>
<span class="err">$</span><span class="n">args</span> <span class="err">这个变量等于请求行中的参数。</span>
<span class="err">$</span><span class="n">binary_remote_addr</span> <span class="err">二进制码形式的客户端地址。</span>
<span class="err">$</span><span class="n">body_bytes_sent</span>
<span class="err">$</span><span class="n">content_length</span> <span class="err">请求头中的</span><span class="n">Content</span><span class="o">-</span><span class="n">length</span><span class="err">字段。</span>
<span class="err">$</span><span class="n">content_type</span> <span class="err">请求头中的</span><span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="err">字段。</span>
<span class="err">$</span><span class="n">cookie_COOKIE</span> <span class="n">cookie</span> <span class="n">COOKIE</span><span class="err">的值。</span>
<span class="err">$</span><span class="n">document_root</span> <span class="err">当前请求在</span><span class="n">root</span><span class="err">指令中指定的值。</span>
<span class="err">$</span><span class="n">document_uri</span> <span class="err">与$</span><span class="n">uri</span><span class="err">相同。</span>
<span class="err">$</span><span class="n">host</span> <span class="err">请求中的主机头字段，如果请求中的主机头不可用，则为服务器处理请求的服务器名称。</span>
<span class="err">$</span><span class="n">is_args</span> <span class="err">如果$</span><span class="n">args</span><span class="err">设置，值为</span><span class="s">&quot;?&quot;</span><span class="err">，否则为</span><span class="s">&quot;&quot;</span><span class="err">。</span>
<span class="err">$</span><span class="n">limit_rate</span> <span class="err">这个变量可以限制连接速率。</span>
<span class="err">$</span><span class="n">nginx_version</span> <span class="err">当前运行的</span><span class="n">nginx</span><span class="err">版本号。</span>
<span class="err">$</span><span class="n">query_string</span> <span class="err">与$</span><span class="n">args</span><span class="err">相同。</span>
<span class="err">$</span><span class="n">remote_addr</span> <span class="err">客户端的</span><span class="n">IP</span><span class="err">地址。</span>
<span class="err">$</span><span class="n">remote_port</span> <span class="err">客户端的端口。</span>
<span class="err">$</span><span class="n">remote_user</span> <span class="err">已经经过</span><span class="n">Auth</span> <span class="n">Basic</span> <span class="n">Module</span><span class="err">验证的用户名。</span>
<span class="err">$</span><span class="n">request_filename</span> <span class="err">当前连接请求的文件路径，由</span><span class="n">root</span><span class="err">或</span><span class="n">alias</span><span class="err">指令与</span><span class="n">URI</span><span class="err">请求生成。</span>
<span class="err">$</span><span class="n">request_body</span> <span class="err">这个变量（</span><span class="mf">0.7.58</span><span class="o">+</span><span class="err">）包含请求的主要信息。在使用</span><span class="n">proxy_pass</span><span class="err">或</span><span class="n">fastcgi_pass</span><span class="err">指令的</span><span class="n">location</span><span class="err">中比较有意义。</span>
<span class="err">$</span><span class="n">request_body_file</span> <span class="err">客户端请求主体信息的临时文件名。</span>
<span class="err">$</span><span class="n">request_completion</span> <span class="err">请求完成</span>
<span class="err">$</span><span class="n">request_method</span> <span class="err">这个变量是客户端请求的动作，通常为</span><span class="n">GET</span><span class="err">或</span><span class="n">POST</span><span class="err">。包括</span><span class="mf">0.8.20</span><span class="err">及之前的版本中，这个变量总为</span><span class="n">main</span> <span class="n">request</span><span class="err">中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作。</span>
<span class="err">$</span><span class="n">request_uri</span> <span class="err">这个变量等于包含一些客户端请求参数的原始</span><span class="n">URI</span><span class="err">，它无法修改，请查看$</span><span class="n">uri</span><span class="err">更改或重写</span><span class="n">URI</span><span class="err">。</span>
<span class="err">$</span><span class="n">schemeHTTP</span> <span class="err">方法（如</span><span class="n">http</span><span class="err">，</span><span class="n">https</span><span class="err">）。按需使用，例：</span>
<span class="n">rewrite</span> <span class="o">^</span><span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">$</span> <span class="err">$</span><span class="n">scheme</span><span class="o">:</span><span class="c1">//example.com$1 redirect;</span>
<span class="err">$</span><span class="n">server_addr</span> <span class="err">服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在</span><span class="n">listen</span><span class="err">中指定地址并且使用</span><span class="n">bind</span><span class="err">参数。</span>
<span class="err">$</span><span class="n">server_name</span> <span class="err">服务器名称。</span>
<span class="err">$</span><span class="n">server_port</span> <span class="err">请求到达服务器的端口号。</span>
<span class="err">$</span><span class="n">server_protocol</span> <span class="err">请求使用的协议，通常是</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.0</span><span class="err">或</span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="err">。</span>
<span class="err">$</span><span class="n">uri</span> <span class="err">请求中的当前</span><span class="n">URI</span><span class="p">(</span><span class="err">不带请求参数，参数位于$</span><span class="n">args</span><span class="p">)</span><span class="err">，可以不同于浏览器传递的$</span><span class="n">request_uri</span><span class="err">的值，它可以通过内部重定向，或者使用</span><span class="n">index</span><span class="err">指令进行修改。</span>
</pre></div>
    </section>

    <section id="copyright">
        <div class="copyright">
            版权声明：自由转载-非商用-非衍生-保持署名 | <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank" >Creative Commons BY-NC-ND 3.0</a>
        </div>
    </section>

    <section id="comments">

        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_identifier = "/posts/2013/11/23/nginx-base.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://wklken.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            </div>
    </section>

</article>
        </section><!--end #main-->

            <footer class="row">
                <div class="large-12 columns">
                    <p>
                            Copyright © 2014 wklken <br>
                            Powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Social Icons by <a href="http://fortawesome.github.io/Font-Awesome/">Font-Awesome</a>.
                    </p>
                </div>
            </footer>

            </div>
        </div>

        <section id="extras" class="body">
        </section><!-- /#extras -->

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-42275748-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>


<script src="http://upcdn.b0.upaiyun.com/libs/jquery/jquery-1.9.1.min.js"></script>

<script src="/theme/js/instantclick.min.js" data-no-instant></script>
<script data-no-instant>InstantClick.init(50);</script>

<script src="/theme/js/jquery.ui.totop.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $().UItoTop({ easingType: 'easeOutQuart' });
    });
</script>

</body>
</html>